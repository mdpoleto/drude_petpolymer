* $Id: test_drude_petpolymer.str 2024-08-26 00:28:47 marcelo $
* Test case, Drude PET polymer, ligands and model compounds toppar file
*


set boml 0 

set mindr 1 ! we want to minimization

set count 1
set nres 9

!model compounds
set resi1  3CB
set resi2  MBOA
set resi3  2HEB
set resi4  TPA
set resi5  MTPA
set resi6  12ED
set resi7  EGDA
!ligands
set resi8  MHET
set resi9  BHET
!polymer
set resi10 PET


set seed1  1 CG  1 CD1 1 CE1
set seed2  1 C1  1 C2  1 C3
set seed3  1 C1  1 C2  1 C3
set seed4  1 C1  1 C2  1 C3
set seed5  1 C1  1 C2  1 C3
set seed6  1 C1A 1 C2A 1 C3A
set seed7  1 C4  1 CX2 1 O3
set seed8  1 C1  1 C2  1 C3
set seed9  1 C1  1 C2  1 C3
set seed10 1 C1  1 C2  1 C3


label loop_model1

set residue @resi@@count
read sequence @residue 1

bomlev @boml
generate @residue first none last none setup warn drude dmass 0.4 !show

ic param
ic seed @seed@@count
ic build 
ic print
coor print
coor sdrude
coor shake
!coor print
bomlev 0

! instead of relaxing Drude, move all Drude a little bit away from their parent atom
!coor trans xdir -0.002 ydir -0.002 zdir -0.002 sele type D* end

update inbfrq -1 ihbfrq 0 switch atom vatom vswitch cutnb 999.0 ctofnb 997.0 ctonnb 995.0

if @mindr eq 0 then
  energy
 else
  cons harm force 100000. sele .not. type D* end
  mini SD   nstep 1000 tolgrd 0.0001 nprint 50
  mini ABNR nstep 500  tolgrd 0.0001 nprint 50
  ic fill
  ic print
  cons harm clear
endif
echo @residue starting E: ?ener

if @?pdbdir eq 1 then
  write psf card name @pdbdir/@residue.psf
  write coor pdb name @pdbdir/@residue_start.pdb
 endif

if @mini ne 0 then
  mini sd nstep 1000 tolgrd 0.0001 nprint 100
  if ?grms gt 0.0001 mini abnr nstep 1000 tolgrd 0.0001
  if ?grms gt 0.0001 then
    echo FATAL ERROR: MINIMIZATION NOT CONVERGED
    echu
    echo FATAL ERROR: MINIMIZATION NOT CONVERGED
    stop
   endif
  echo @residue minimized E: ?ener
  if @?pdbdir eq 1 then ! cannot use 1-line syntax because substitution will fail
    write coor pdb name @pdbdir/@residue_min.pdb
   endif
 endif

coor orient
coor dipole oxyz select all end 
echo @residue dipole: ?rdip
!! Check molecular polarizability
!VIBRAN
!diag dscf fini step 0.001
!END


! Write minimized MM geometry
open write unit 13 card name @residue.pdb
write coor unit 13 pdb
close unit 13


shake off
drude reset
lone clear
delete atom sele all end

incr count
if count le @nres goto loop_model1



! PET polymer and its terminal patches

set count 1
set npatch 3

set patch1 MET
set patch2 COO
set patch3 EOH


label loop_pet

set residue @resi10
set termini @patch@@count

read sequence @residue 1

bomlev @boml
generate @residue first L@termini last R@termini setup warn drude dmass 0.4 !show

ic param
ic seed @seed10
ic build 
!ic print
!coor print
coor sdrude
coor shake
coor print
bomlev 0

! instead of relaxing Drude, move all Drude a little bit away from their parent atom
!coor trans xdir -0.002 ydir -0.002 zdir -0.002 sele type D* end

update inbfrq -1 ihbfrq 0 switch atom vatom vswitch cutnb 999.0 ctofnb 997.0 ctonnb 995.0

if @mindr eq 0 then
  energy
 else
  cons harm force 100000. sele .not. type D* end
  mini SD   nstep 1000 tolgrd 0.0001 nprint 50
  mini ABNR nstep 500  tolgrd 0.0001 nprint 50
  ic fill
  ic print
  cons harm clear
endif
echo @residue starting E: ?ener

if @?pdbdir eq 1 then
  write psf card name @pdbdir/@residue.psf
  write coor pdb name @pdbdir/@residue_start.pdb
 endif

if @mini ne 0 then
  mini sd nstep 1000 tolgrd 0.0001 nprint 100
  if ?grms gt 0.0001 mini abnr nstep 1000 tolgrd 0.0001
  if ?grms gt 0.0001 then
    echo FATAL ERROR: MINIMIZATION NOT CONVERGED
    echu
    echo FATAL ERROR: MINIMIZATION NOT CONVERGED
    stop
   endif
  echo @residue minimized E: ?ener
  if @?pdbdir eq 1 then ! cannot use 1-line syntax because substitution will fail
    write coor pdb name @pdbdir/@residue_min.pdb
   endif
 endif

coor orient
coor dipole oxyz select all end 
echo @residue dipole: ?rdip
!! Check molecular polarizability
!VIBRAN
!diag dscf fini step 0.001
!END


shake off
drude reset
lone clear
delete atom sele all end

incr count
if count le @npatch goto loop_pet
